name: Download Satellite Image (Debug Mode)

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘ä¾¿äºè°ƒè¯•

jobs:
  download-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup debug environment
        run: |
          # å®‰è£…è°ƒè¯•å·¥å…·
          sudo apt-get update
          sudo apt-get install -y jq
          pip install --upgrade pip

      - name: Debug Step 1 - Download JS file
        run: |
          JS_URL="https://www.cwa.gov.tw/Data/js/obs_img/Observe_sat.js"
          echo "â–¶ï¸ æ­£åœ¨ä¸‹è½½ JS æ–‡ä»¶..."
          curl -v -s $JS_URL -o satimg.js
          
          echo "ğŸ” æ–‡ä»¶å†…å®¹å‰100å­—ç¬¦:"
          head -c 100 satimg.js
          echo -e "\n\nğŸ“¦ æ–‡ä»¶å¤§å°:" $(wc -c < satimg.js) "bytes"
          echo "âœ… ä¸‹è½½å®Œæˆ"

      - name: Debug Step 2 - Inspect JS structure
        run: |
          echo "ğŸ” æ£€æŸ¥ JS æ–‡ä»¶ç»“æ„..."
          echo "1. æŸ¥æ‰¾ SatImg å®šä¹‰:"
          grep -n "var SatImg" satimg.js || echo "âŒ æœªæ‰¾åˆ° SatImg å®šä¹‰"
          
          echo -e "\n2. æ£€æŸ¥ Tab4 ç»“æ„:"
          grep -A 10 "Tab4" satimg.js || echo "âŒ æœªæ‰¾åˆ° Tab4 å®šä¹‰"
          
          echo -e "\n3. æ£€æŸ¥ img å­—æ®µç¤ºä¾‹:"
          grep -m 3 "img" satimg.js || echo "âŒ æœªæ‰¾åˆ° img å­—æ®µ"

      - name: Debug Step 3 - Fixed Python parser
  run: |
    cat << 'EOF' > fixed_parser.py
    import re, json, sys

    def debug_print(label, content):
        print(f"ğŸ”§ [DEBUG] {label}:")
        print(content)
        print("-"*50)

    try:
        # è¯»å–æ–‡ä»¶
        with open("satimg.js") as f:
            js = f.read()
        debug_print("åŸå§‹JS", js[:200] + "...")
        
        # æ”¹è¿›çš„å¤šè¡ŒåŒ¹é…
        match = re.search(r"var SatImg\s*=\s*({[\s\S]*?});", js)
        if not match:
            print("âŒ é”™è¯¯ï¼šæœªåŒ¹é…åˆ°SatImgå¯¹è±¡")
            debug_print("å»ºè®®", "æ£€æŸ¥JSæ–‡ä»¶æ˜¯å¦åŒ…å«å®Œæ•´çš„var SatImg = {...};")
            sys.exit(1)
        
        json_str = match.group(1)
        debug_print("æå–çš„å¯¹è±¡", json_str[:200] + "...")
        
        # è½¬æ¢JSå¯¹è±¡ä¸ºåˆæ³•JSON
        json_str = (
            json_str.replace("'", '"')
            .replace("True", "true")
            .replace("False", "false")
        )
        json_str = re.sub(r"([\{,])\s*([a-zA-Z_]\w*)\s*:", r'\1"\2":', json_str)
        
        debug_print("è½¬æ¢åçš„JSON", json_str[:200] + "...")
        
        # è§£æå¹¶è·å–ç›®æ ‡å€¼
        data = json.loads(json_str)
        img_path = data["Tab4"]["Area1"]["size0"]["C"]["0"]["img"]
        print(f"::set-output name=image_url::https://www.cwa.gov.tw/Data/satellite/{img_path}")
        print(f"::set-output name=image_name::{img_path.split('/')[-1]}")
        
    except Exception as e:
        print(f"âŒ è§£æå¤±è´¥: {type(e).__name__}: {e}")
        sys.exit(1)
    EOF

    python3 fixed_parser.py


      - name: Debug Step 4 - Run parser
        id: parser
        run: |
          echo "â–¶ï¸ å¼€å§‹æ‰§è¡Œè§£æå™¨..."
          python3 debug_parser.py
          echo "âœ… è§£æå®Œæˆ"
          
          # éªŒè¯è¾“å‡º
          echo -e "\nğŸ”„ è¾“å‡ºå˜é‡æ£€æŸ¥:"
          echo "image_url: ${{ steps.parser.outputs.image_url }}"
          echo "image_name: ${{ steps.parser.outputs.image_name }}"

      - name: Debug Step 5 - Download test
        if: steps.parser.outputs.image_url
        run: |
          echo "â–¶ï¸ æµ‹è¯•ä¸‹è½½å›¾ç‰‡..."
          mkdir -p debug_images
          curl -v -o "debug_images/${{ steps.parser.outputs.image_name }}" \
            "${{ steps.parser.outputs.image_url }}"
          
          echo -e "\nğŸ“Š ä¸‹è½½ç»“æœ:"
          ls -lh debug_images/
          file "debug_images/${{ steps.parser.outputs.image_name }}"
          echo "âœ… ä¸‹è½½æµ‹è¯•å®Œæˆ"

      - name: Debug Report
        if: always()
        run: |
          echo -e "\nğŸ“ è°ƒè¯•æŠ¥å‘Š:"
          echo "1. JSæ–‡ä»¶ä¸‹è½½: ${{ steps['Debug Step 1 - Download JS file'].outcome }}"
          echo "2. ç»“æ„æ£€æŸ¥: ${{ steps['Debug Step 2 - Inspect JS structure'].outcome }}"
          echo "3. è§£æå™¨æ‰§è¡Œ: ${{ steps['Debug Step 4 - Run parser'].outcome }}"
          echo "4. ä¸‹è½½æµ‹è¯•: ${{ steps['Debug Step 5 - Download test'].outcome || 'æœªæ‰§è¡Œ' }}"
          
          echo -e "\nğŸ”— å›¾ç‰‡URL: ${{ steps.parser.outputs.image_url || 'æœªç”Ÿæˆ' }}"
          echo "ğŸ–¼ï¸ å›¾ç‰‡åç§°: ${{ steps.parser.outputs.image_name || 'æœªç”Ÿæˆ' }}"
