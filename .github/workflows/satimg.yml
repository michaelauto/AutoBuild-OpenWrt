name: Fetch and Parse SatImg

on:
  workflow_dispatch:

jobs:
  fetch-satimg:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch and parse SatImg
        run: |
          const https = require('https');

          function fetchJS(url) {
            return new Promise((resolve, reject) => {
              https.get(url, res => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(data));
              }).on('error', err => reject(err));
            });
          }

          (async () => {
            const url = 'https://www.cwa.gov.tw/Data/js/obs_img/Observe_sat.js';
            const jsCode = await fetchJS(url);

            // JS 文件里是类似 var SatImg = {...}，我们提取对象部分执行
            const vm = require('vm');
            const context = {};
            vm.createContext(context); // 创建隔离上下文
            vm.runInContext(jsCode, context);

            const SatImg = context.SatImg;

            // 找到第一个可用的图像路径和时间
            const imgPath = SatImg['Tab0']['Area0']['size0']['C'][0]['img'];
            const timeText = SatImg['Tab0']['Area0']['size0']['C'][0]['text'];

            console.log('✅ Image Path:', imgPath);
            console.log('✅ Time Text:', timeText);
          })();
        shell: node